<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>L-CAMERA ç»çº¬ç›¸æœº</title>
  <link rel="icon" href="./logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- é«˜å¾·åœ°å›¾JS API -->
  <script src="https://webapi.amap.com/maps?v=2.0&key=5def93a40f67da89524a6d85bd526340"></script>
  <style>
    :root {
      --bg: #0f1115;
      --card: #161a22;
      --text-main: #e6e8ee;
      --text-sub: #9aa0ad;
      --accent: #4da3ff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 50% -200px, #1b2130, var(--bg));
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    /* ============== ç§»åŠ¨ç«¯å…¨å±æ‹ç…§æ¨¡å¼ ============== */
    .mobile-camera-mode {
      display: none;
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 9999;
      flex-direction: column;
    }

    .mobile-camera-mode.active {
      display: flex;
    }

    .mobile-camera-video {
      flex: 1;
      width: 100%;
      object-fit: contain;
    }

    .mobile-camera-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      height: 120px;
    }

    .shutter-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: #fff;
      border: 4px solid rgba(255,255,255,0.3);
      cursor: pointer;
      transition: transform 0.1s;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .shutter-btn img {
      width: 60%;
      height: 60%;
      object-fit: contain;
      pointer-events: none;
    }

    .shutter-btn:active {
      transform: scale(0.9);
    }

    .close-camera-btn {
      position: absolute;
      top: 2vh;
      left: 4vw;
      width: 40px;
      height: 40px;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    /* æ‹ç…§åçš„é¢„è§ˆå’Œä¿å­˜ç•Œé¢ */
    .photo-preview-mode {
      display: none;
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 10000;
      flex-direction: column;
    }

    .photo-preview-mode.active {
      display: flex;
    }

    .photo-preview-img {
      flex: 1;
      width: 100%;
      object-fit: contain;
    }

    .long-press-tip {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      pointer-events: none;
      z-index: 10;
      animation: fadeInOut 3s ease-in-out;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }

    .photo-preview-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      display: flex;
      justify-content: space-around;
      align-items: center;
      gap: 15px;
      height: 100px;
    }

    .preview-btn {
      flex: 1;
      padding: 14px 20px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .preview-btn:active {
      transform: scale(0.95);
    }

    .preview-btn.cancel {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }

    .preview-btn.save {
      background: var(--accent);
      color: #000;
    }

    /* ============== æ¡Œé¢ç«¯å¸ƒå±€ ============== */
    .desktop-container {
      height: 100vh;
      width: 100vw;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: clamp(10px, 1.5vw, 20px);
      padding: clamp(10px, 1.5vw, 20px);
    }

    .panel {
      background: linear-gradient(180deg, #1a1f2b, var(--card));
      border-radius: clamp(12px, 1vw, 16px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
      padding: clamp(16px, 2vw, 28px);
      overflow: auto;
      display: flex;
      flex-direction: column;
    }

    .info-panel {
      grid-row: 1 / 3;
    }

    .camera-panel {
      display: flex;
      flex-direction: column;
      gap: clamp(10px, 1vw, 15px);
    }

    .preview-panel {
      display: flex;
      flex-direction: column;
    }

    .title {
      font-size: clamp(14px, 1.2vw, 18px);
      letter-spacing: 0.08em;
      color: var(--text-sub);
      margin-bottom: clamp(12px, 1.5vw, 20px);
      flex-shrink: 0;
    }

    .block {
      margin-bottom: clamp(10px, 1.2vw, 16px);
      flex-shrink: 0;
    }

    .label {
      font-size: clamp(10px, 0.8vw, 12px);
      color: var(--text-sub);
      margin-bottom: clamp(4px, 0.5vw, 6px);
    }

    .value {
      font-size: clamp(16px, 1.5vw, 22px);
      font-weight: 600;
      line-height: 1.3;
      word-break: break-all;
    }

    .value.small {
      font-size: clamp(12px, 1vw, 15px);
      font-weight: 500;
      color: var(--text-sub);
    }

    .time {
      padding-top: clamp(10px, 1vw, 18px);
      border-top: 1px solid rgba(255,255,255,0.06);
    }

    .time .value {
      font-size: clamp(16px, 1.6vw, 24px);
      color: var(--accent);
      font-variant-numeric: tabular-nums;
    }

    .btn {
      width: 100%;
      padding: clamp(10px, 1vw, 14px) 0;
      border-radius: clamp(8px, 0.8vw, 12px);
      border: none;
      font-size: clamp(13px, 1vw, 15px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .btn.primary {
      background: #ffffff;
      color: #0f1115;
    }

    .btn.secondary {
      background: #2b3142;
      color: var(--text-main);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .video-container {
      width: 100%;
      flex: 1;
      background: #000;
      border-radius: clamp(10px, 1vw, 14px);
      overflow: hidden;
      min-height: 0;
      position: relative;
    }

    .video-container video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .preview-container {
      width: 100%;
      flex: 1;
      background: #000;
      border-radius: clamp(10px, 1vw, 14px);
      overflow: hidden;
      min-height: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .preview-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .preview-container .placeholder {
      color: var(--text-sub);
      font-size: clamp(12px, 1vw, 14px);
    }

    .download-link {
      text-align: center;
      display: inline-block;
      margin-top: clamp(8px, 0.8vw, 12px);
      padding: clamp(8px, 0.8vw, 12px) clamp(16px, 1.5vw, 24px);
      background: linear-gradient(135deg, var(--accent), #3d8fe8);
      color: #0f1115;
      font-size: clamp(12px, 1vw, 14px);
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      flex-shrink: 0;
      border-radius: clamp(6px, 0.6vw, 8px);
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(77, 163, 255, 0.3);
    }

    canvas {
      display: none;
    }

    /* ============== ç§»åŠ¨ç«¯å¸ƒå±€ ============== */
    @media (max-width: 768px) {
      body {
        overflow: auto;
      }

      .desktop-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: auto;
        min-height: 100vh;
        padding: 20px;
      }

      .panel {
        width: 100%;
        margin-bottom: 0;
      }

      .info-panel {
        display: block;
        text-align: center;
      }
      
      .info-panel .label {
        text-align: center;
      }
      
      .info-panel .value {
        text-align: center;
      }

      .camera-panel,
      .preview-panel {
        display: none;
      }

      .mobile-only {
        display: block !important;
      }

      .desktop-only {
        display: none !important;
      }

      .value {
        font-size: 20px;
      }

      .value.small {
        font-size: 14px;
      }

      .time .value {
        font-size: 22px;
      }

      .btn {
        padding: 14px 0;
        font-size: 16px;
      }
    }

    .mobile-only {
      display: none;
    }
  </style>
</head>
<body>
  <!-- ç§»åŠ¨ç«¯å…¨å±æ‹ç…§æ¨¡å¼ -->
  <div class="mobile-camera-mode" id="mobileCameraMode">
    <button class="close-camera-btn" id="closeMobileCamera">Ã—</button>
    <video class="mobile-camera-video" id="mobileVideo" autoplay playsinline muted></video>
    <div class="mobile-camera-controls">
      <button class="shutter-btn" id="mobileShutter">
        <img src="./photo.png" alt="æ‹ç…§">
      </button>
    </div>
  </div>

  <!-- ç§»åŠ¨ç«¯æ‹ç…§é¢„è§ˆæ¨¡å¼ -->
  <div class="photo-preview-mode" id="photoPreviewMode">
    <div class="long-press-tip" id="longPressTip">ğŸ’¡ é•¿æŒ‰å›¾ç‰‡ä¹Ÿå¯ä¿å­˜</div>
    <img class="photo-preview-img" id="photoPreviewImg" alt="æ‹ç…§é¢„è§ˆ">
    <div class="photo-preview-controls">
      <button class="preview-btn cancel" id="cancelPhoto">é‡æ‹</button>
      <button class="preview-btn save" id="savePhoto">ä¿å­˜ç…§ç‰‡</button>
    </div>
  </div>

  <!-- æ¡Œé¢ç«¯/ç§»åŠ¨ç«¯ä¸»ç•Œé¢ -->
  <div class="desktop-container">
    <!-- åœ°ç†ä½ç½®å’Œæ—¶é—´ä¿¡æ¯ -->
    <div class="panel info-panel">
      <div class="title">L-CAMERA</div>

      <div class="block">
        <div class="label">çº¬åº¦</div>
        <div class="value" id="latitude">è·å–ä¸­â€¦</div>
      </div>

      <div class="block">
        <div class="label">ç»åº¦</div>
        <div class="value" id="longitude">è·å–ä¸­â€¦</div>
      </div>

      <div class="block">
        <div class="label">æ‰€åœ¨ä½ç½®</div>
        <div class="value small" id="address">è§£æä¸­â€¦</div>
      </div>

      <div class="block">
        <div class="label">å®šä½ç²¾åº¦</div>
        <div class="value small" id="accuracy">â€”</div>
      </div>

      <div class="block">
        <div class="label">å®šä½æœ€åæ›´æ–°æ—¶é—´</div>
        <div class="value small" id="locationUpdateTime">â€”</div>
      </div>

      <div class="block">
        <div class="label">è®¾å¤‡æœå‘</div>
        <div class="value small" id="orientation">æ£€æµ‹ä¸­â€¦</div>
      </div>

      <div class="block">
        <div class="label">å¤©æ°”ä¿¡æ¯</div>
        <div class="value small" id="weather">è·å–ä¸­â€¦</div>
      </div>

      <div class="block time">
        <div class="label">å½“å‰æ—¶é—´</div>
        <div class="value" id="time">â€”</div>
      </div>

      <!-- ç§»åŠ¨ç«¯ä¸“ç”¨æŒ‰é’® -->
      <div class="block mobile-only" style="margin-top: 20px;">
        <button class="btn primary" id="openMobileCamera">æ‰“å¼€æ‘„åƒå¤´</button>
      </div>

      <!-- æ¡Œé¢ç«¯ä¸“ç”¨æŒ‰é’® -->
      <div class="block desktop-only" style="margin-top: 20px;">
        <button class="btn secondary" id="openCamera">æ‰“å¼€æ‘„åƒå¤´</button>
      </div>
      <div class="block desktop-only">
        <button class="btn primary" id="takePhoto" style="display: none;">æ‹ç…§</button>
      </div>
    </div>

    <!-- æ‘„åƒå¤´å–æ™¯ -->
    <div class="panel camera-panel desktop-only">
      <div class="title">é¢„ è§ˆ</div>
      <div class="video-container">
        <video id="video" autoplay playsinline muted></video>
      </div>
    </div>

    <!-- ç…§ç‰‡é¢„è§ˆ -->
    <div class="panel preview-panel desktop-only">
      <div class="title">å½± åƒ</div>
      <div class="preview-container" id="previewContainer">
        <div class="placeholder">ç…§ç‰‡å±•ç¤ºåŒºåŸŸ</div>
        <img id="preview" style="display: none;" alt="ç…§ç‰‡å±•ç¤º">
      </div>
      <a class="download-link" id="download" style="display: none;">ä¸‹è½½å›¾ç‰‡</a>
    </div>
  </div>

  <canvas id="canvas"></canvas>

  <script>
    // ============== åŸºç¡€å˜é‡ ==============
    const latEl = document.getElementById('latitude');
    const lngEl = document.getElementById('longitude');
    const accEl = document.getElementById('accuracy');
    const timeEl = document.getElementById('time');
    const addrEl = document.getElementById('address');
    const locationUpdateTimeEl = document.getElementById('locationUpdateTime');
    const orientationEl = document.getElementById('orientation');
    const weatherEl = document.getElementById('weather');

    // æ¡Œé¢ç«¯å…ƒç´ 
    const video = document.getElementById('video');
    const openBtn = document.getElementById('openCamera');
    const takeBtn = document.getElementById('takePhoto');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('previewContainer');
    const download = document.getElementById('download');

    // ç§»åŠ¨ç«¯å…ƒç´ 
    const openMobileBtn = document.getElementById('openMobileCamera');
    const mobileCameraMode = document.getElementById('mobileCameraMode');
    const mobileVideo = document.getElementById('mobileVideo');
    const closeMobileCamera = document.getElementById('closeMobileCamera');
    const mobileShutter = document.getElementById('mobileShutter');
    const photoPreviewMode = document.getElementById('photoPreviewMode');
    const photoPreviewImg = document.getElementById('photoPreviewImg');
    const cancelPhoto = document.getElementById('cancelPhoto');
    const savePhoto = document.getElementById('savePhoto');
    const longPressTip = document.getElementById('longPressTip');

    let stream = null;
    let isMobile = window.innerWidth <= 768;
    let locationPermissionGranted = false;
    let locationWatchId = null;
    let amapGeolocation = null; // é«˜å¾·å®šä½å¯¹è±¡
    let amapLocationTimer = null; // é«˜å¾·å®šä½å®šæ—¶å™¨

    // ============== æ£€æŸ¥æ‘„åƒå¤´æ”¯æŒ ==============
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      console.warn('æ­¤æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´API');
      if (openBtn) {
        openBtn.disabled = true;
        openBtn.textContent = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´';
      }
      if (openMobileBtn) {
        openMobileBtn.disabled = true;
        openMobileBtn.textContent = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´';
      }
    }

    // ============== æ—¶é—´æ›´æ–° ==============
    function updateTime() {
      const n = new Date();
      timeEl.textContent =
        n.getFullYear() + '-' +
        String(n.getMonth() + 1).padStart(2, '0') + '-' +
        String(n.getDate()).padStart(2, '0') + ' ' +
        String(n.getHours()).padStart(2, '0') + ':' +
        String(n.getMinutes()).padStart(2, '0') + ':' +
        String(n.getSeconds()).padStart(2, '0') + '.' +
        String(n.getMilliseconds()).padStart(3, '0');
    }

    setInterval(updateTime, 10);
    updateTime();

    // ============== è·å–å¤©æ°”ä¿¡æ¯ ==============
    function getWeather(adcode) {
      const url = `https://restapi.amap.com/v3/weather/weatherInfo?key=5def93a40f67da89524a6d85bd526340&city=${adcode}`;
      
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.status === '1' && data.lives && data.lives.length > 0) {
            const weather = data.lives[0];
            // æ ¼å¼åŒ–å¤©æ°”ä¿¡æ¯ä¸ºä¸€è¡Œå­—ç¬¦ä¸²ï¼Œç”¨ç©ºæ ¼éš”å¼€
            const weatherStr = `${weather.weather} ${weather.temperature}â„ƒ ${weather.winddirection}é£ ${weather.windpower}çº§ æ¹¿åº¦${weather.humidity}%`;
            weatherEl.textContent = weatherStr;
          } else {
            weatherEl.textContent = 'æ— æ³•è·å–å¤©æ°”ä¿¡æ¯';
          }
        })
        .catch(() => {
          weatherEl.textContent = 'å¤©æ°”è·å–å¤±è´¥';
        });
    }

    // ============== åœ°ç†ä½ç½®åå‘è§£æ ==============
    function reverseGeocode(lat, lon) {
      // é«˜å¾·åœ°å›¾é€†åœ°ç†ç¼–ç æ¥å£ï¼Œæ³¨æ„å‚æ•°é¡ºåºæ˜¯ï¼šç»åº¦,çº¬åº¦
      const url = `https://restapi.amap.com/v3/geocode/regeo?key=5def93a40f67da89524a6d85bd526340&location=${lon},${lat}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          // é«˜å¾·æ¥å£è¿”å›æ ¼å¼ï¼šstatus=1è¡¨ç¤ºæˆåŠŸï¼Œå– regeocode.formatted_address
          if (data.status === '1' && data.regeocode && data.regeocode.formatted_address) {
            addrEl.textContent = data.regeocode.formatted_address;
            
            // è·å– adcode å¹¶è¯·æ±‚å¤©æ°”ä¿¡æ¯
            if (data.regeocode.addressComponent && data.regeocode.addressComponent.adcode) {
              getWeather(data.regeocode.addressComponent.adcode);
            }
          } else {
            addrEl.textContent = 'æ— æ³•è§£æå…·ä½“ä½ç½®';
          }
        })
        .catch(() => {
          addrEl.textContent = 'ä½ç½®è§£æå¤±è´¥';
        });
    }

    // ============== è·å–åœ°ç†ä½ç½®ï¼ˆä½¿ç”¨é«˜å¾·å®šä½ï¼‰ ==============
    function initAmapGeolocation() {
      if (!window.AMap) {
        console.error('é«˜å¾·åœ°å›¾APIæœªåŠ è½½');
        // é™çº§åˆ°æµè§ˆå™¨åŸç”Ÿå®šä½
        useBrowserGeolocation();
        return;
      }

      // åˆ›å»ºé«˜å¾·å®šä½å¯¹è±¡
      AMap.plugin('AMap.Geolocation', function() {
        amapGeolocation = new AMap.Geolocation({
          enableHighAccuracy: true,    // æ˜¯å¦ä½¿ç”¨é«˜ç²¾åº¦å®šä½ï¼Œé»˜è®¤ï¼štrue
          timeout: 10000,               // è¶…è¿‡10ç§’ååœæ­¢å®šä½ï¼Œé»˜è®¤ï¼š5s
          position: 'RB',               // å®šä½æŒ‰é’®çš„åœé ä½ç½®
          offset: [10, 20],             // å®šä½æŒ‰é’®ä¸è®¾ç½®çš„åœé ä½ç½®çš„åç§»é‡
          zoomToAccuracy: false,        // å®šä½æˆåŠŸåæ˜¯å¦è‡ªåŠ¨è°ƒæ•´åœ°å›¾è§†é‡åˆ°å®šä½ç‚¹
          showButton: false,            // æ˜¯å¦æ˜¾ç¤ºå®šä½æŒ‰é’®
          showMarker: false,            // æ˜¯å¦æ˜¾ç¤ºå®šä½ç‚¹
          showCircle: false,            // æ˜¯å¦æ˜¾ç¤ºå®šä½ç²¾åº¦åœˆ
          panToLocation: false,         // å®šä½æˆåŠŸåæ˜¯å¦è‡ªåŠ¨ç§»åŠ¨åˆ°å®šä½ä½ç½®
          extensions: 'all'             // è¿”å›è¯¦ç»†ä¿¡æ¯
        });

        // æ‰§è¡Œå®šä½
        updateLocationWithAmap();
      });
    }

    function updateLocationWithAmap() {
      if (!amapGeolocation) {
        initAmapGeolocation();
        return;
      }

      amapGeolocation.getCurrentPosition(function(status, result) {
        if (status === 'complete') {
          // å®šä½æˆåŠŸ
          onAmapLocationSuccess(result);
        } else {
          // å®šä½å¤±è´¥
          onAmapLocationError(result);
        }
      });
    }

    function onAmapLocationSuccess(data) {
      console.log('é«˜å¾·å®šä½æˆåŠŸ:', data);
      
      const latitude = data.position.lat;
      const longitude = data.position.lng;
      const accuracy = data.accuracy || 0;

      latEl.textContent = latitude.toFixed(8);
      lngEl.textContent = longitude.toFixed(8);
      accEl.textContent = accuracy.toFixed(2) + 'ç±³';
      
      // ä½¿ç”¨é«˜å¾·è¿”å›çš„åœ°å€ä¿¡æ¯
      if (data.formattedAddress) {
        addrEl.textContent = data.formattedAddress;
      } else {
        reverseGeocode(latitude, longitude);
      }
      
      // è·å–å¤©æ°”ï¼ˆä½¿ç”¨é«˜å¾·è¿”å›çš„adcodeï¼‰
      if (data.addressComponent && data.addressComponent.adcode) {
        getWeather(data.addressComponent.adcode);
      }
      
      locationPermissionGranted = true;
      
      // æ›´æ–°å®šä½æ—¶é—´
      const now = new Date();
      const timeStr = now.getFullYear() + '-' +
        String(now.getMonth() + 1).padStart(2, '0') + '-' +
        String(now.getDate()).padStart(2, '0') + ' ' +
        String(now.getHours()).padStart(2, '0') + ':' +
        String(now.getMinutes()).padStart(2, '0') + ':' +
        String(now.getSeconds()).padStart(2, '0') + '.' +
        String(now.getMilliseconds()).padStart(3, '0');
      locationUpdateTimeEl.textContent = timeStr;
    }

    function onAmapLocationError(data) {
      console.error('é«˜å¾·å®šä½å¤±è´¥:', data);
      
      let errorMsg = 'å®šä½å¤±è´¥';
      
      // é«˜å¾·å®šä½é”™è¯¯ç è¯´æ˜
      if (data.info === 'NOT_SUPPORTED') {
        errorMsg = 'æµè§ˆå™¨ä¸æ”¯æŒå®šä½';
      } else if (data.info === 'FAILED') {
        errorMsg = isMobile ? 'å®šä½å¤±è´¥ï¼ˆç‚¹å‡»æŒ‰é’®é‡è¯•ï¼‰' : 'å®šä½å¤±è´¥';
      } else if (data.message && data.message.includes('Geolocation permission denied')) {
        errorMsg = isMobile ? 'æœªæˆæƒï¼ˆç‚¹å‡»æŒ‰é’®ç”³è¯·ï¼‰' : 'å®šä½æƒé™è¢«æ‹’ç»';
      } else if (data.message) {
        errorMsg = 'å®šä½å¤±è´¥: ' + data.message;
      }
      
      if (latEl) latEl.textContent = errorMsg;
      if (lngEl) lngEl.textContent = errorMsg;
      if (accEl) accEl.textContent = 'â€”';
      if (addrEl) addrEl.textContent = 'â€”';
      if (locationUpdateTimeEl) locationUpdateTimeEl.textContent = 'â€”';
      
      // å¦‚æœé«˜å¾·å®šä½å¤±è´¥ï¼Œå°è¯•é™çº§åˆ°æµè§ˆå™¨åŸç”Ÿå®šä½
      console.log('å°è¯•é™çº§åˆ°æµè§ˆå™¨åŸç”Ÿå®šä½...');
      useBrowserGeolocation();
    }

    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æµè§ˆå™¨åŸç”Ÿå®šä½
    function useBrowserGeolocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const { latitude, longitude, accuracy } = pos.coords;
            latEl.textContent = latitude.toFixed(8) + ' (æµè§ˆå™¨å®šä½)';
            lngEl.textContent = longitude.toFixed(8) + ' (æµè§ˆå™¨å®šä½)';
            accEl.textContent = accuracy.toFixed(2) + 'ç±³';
            reverseGeocode(latitude, longitude);
            locationPermissionGranted = true;
            
            // æ›´æ–°å®šä½æ—¶é—´
            const now = new Date();
            const timeStr = now.getFullYear() + '-' +
              String(now.getMonth() + 1).padStart(2, '0') + '-' +
              String(now.getDate()).padStart(2, '0') + ' ' +
              String(now.getHours()).padStart(2, '0') + ':' +
              String(now.getMinutes()).padStart(2, '0') + ':' +
              String(now.getSeconds()).padStart(2, '0') + '.' +
              String(now.getMilliseconds()).padStart(3, '0');
            locationUpdateTimeEl.textContent = timeStr;
          },
          err => {
            console.error('æµè§ˆå™¨å®šä½ä¹Ÿå¤±è´¥äº†:', err);
            let errorMsg = 'æ‰€æœ‰å®šä½æ–¹å¼å‡å¤±è´¥';
            if (latEl) latEl.textContent = errorMsg;
            if (lngEl) lngEl.textContent = errorMsg;
          },
          {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
          }
        );
      }
    }

    function updateLocation() {
      updateLocationWithAmap();
    }

    // ç§»åŠ¨ç«¯ç²¾ç¡®å®šä½æƒé™ç”³è¯·ï¼ˆä½¿ç”¨é«˜å¾·å®šä½ï¼‰
    function requestPreciseLocation() {
      if (!window.AMap) {
        alert('é«˜å¾·åœ°å›¾APIæœªåŠ è½½ï¼Œå°è¯•ä½¿ç”¨æµè§ˆå™¨å®šä½...');
        requestBrowserLocation();
        return;
      }

      // æ˜¾ç¤ºæç¤º
      const loadingMsg = 'æ­£åœ¨ä½¿ç”¨é«˜å¾·å®šä½è·å–ç²¾ç¡®ä½ç½®...';
      latEl.textContent = loadingMsg;
      lngEl.textContent = loadingMsg;

      // å¦‚æœè¿˜æ²¡åˆ›å»ºé«˜å¾·å®šä½å¯¹è±¡ï¼Œå…ˆåˆ›å»º
      if (!amapGeolocation) {
        AMap.plugin('AMap.Geolocation', function() {
          amapGeolocation = new AMap.Geolocation({
            enableHighAccuracy: true,
            timeout: 10000,
            position: 'RB',
            offset: [10, 20],
            zoomToAccuracy: false,
            showButton: false,
            showMarker: false,
            showCircle: false,
            panToLocation: false,
            extensions: 'all'
          });

          // æ‰§è¡Œå®šä½
          performPreciseLocation();
        });
      } else {
        performPreciseLocation();
      }
    }

    function performPreciseLocation() {
      amapGeolocation.getCurrentPosition(function(status, result) {
        if (status === 'complete') {
          // å®šä½æˆåŠŸ
          const latitude = result.position.lat;
          const longitude = result.position.lng;
          const accuracy = result.accuracy || 0;

          latEl.textContent = latitude.toFixed(8);
          lngEl.textContent = longitude.toFixed(8);
          accEl.textContent = accuracy.toFixed(2) + 'ç±³';
          
          if (result.formattedAddress) {
            addrEl.textContent = result.formattedAddress;
          } else {
            reverseGeocode(latitude, longitude);
          }
          
          if (result.addressComponent && result.addressComponent.adcode) {
            getWeather(result.addressComponent.adcode);
          }
          
          locationPermissionGranted = true;
          
          // æ›´æ–°å®šä½æ—¶é—´
          const now = new Date();
          const timeStr = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + ' ' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0') + ':' +
            String(now.getSeconds()).padStart(2, '0') + '.' +
            String(now.getMilliseconds()).padStart(3, '0');
          locationUpdateTimeEl.textContent = timeStr;

          // ç§»åŠ¨ç«¯æˆæƒæˆåŠŸæç¤º
          if (isMobile) {
            alert('âœ“ é«˜å¾·ç²¾ç¡®å®šä½æˆåŠŸ\n\nå®šä½ç²¾åº¦: ' + accuracy.toFixed(2) + 'ç±³\nå®šä½æ–¹å¼: ' + (result.isConverted ? 'GPS+ç½‘ç»œ' : 'GPS'));
          }

          // å¯åŠ¨æŒç»­å®šä½ï¼ˆç§»åŠ¨ç«¯ï¼Œæ¯30ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
          if (isMobile && !amapLocationTimer) {
            amapLocationTimer = setInterval(() => {
              updateLocationWithAmap();
            }, 30000);
          }
        } else {
          // é«˜å¾·å®šä½å¤±è´¥ï¼Œé™çº§åˆ°æµè§ˆå™¨å®šä½
          console.error('é«˜å¾·å®šä½å¤±è´¥ï¼Œé™çº§åˆ°æµè§ˆå™¨å®šä½');
          requestBrowserLocation();
        }
      });
    }

    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æµè§ˆå™¨åŸç”Ÿå®šä½ï¼ˆä»…åœ¨é«˜å¾·å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
    function requestBrowserLocation() {
      if (!navigator.geolocation) {
        alert('æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒå®šä½åŠŸèƒ½');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude, accuracy } = pos.coords;
          latEl.textContent = latitude.toFixed(8);
          lngEl.textContent = longitude.toFixed(8);
          accEl.textContent = accuracy.toFixed(2) + 'ç±³';
          reverseGeocode(latitude, longitude);
          locationPermissionGranted = true;
          
          const now = new Date();
          const timeStr = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + ' ' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0') + ':' +
            String(now.getSeconds()).padStart(2, '0') + '.' +
            String(now.getMilliseconds()).padStart(3, '0');
          locationUpdateTimeEl.textContent = timeStr;

          if (isMobile) {
            alert('âš ï¸ ä½¿ç”¨æµè§ˆå™¨å®šä½ï¼ˆç²¾åº¦å¯èƒ½è¾ƒä½ï¼‰\n\nå®šä½ç²¾åº¦: ' + accuracy.toFixed(2) + 'ç±³');
          }

          // å¯åŠ¨æŒç»­å®šä½ç›‘å¬ï¼ˆç§»åŠ¨ç«¯ï¼‰
          if (isMobile && !locationWatchId) {
            locationWatchId = navigator.geolocation.watchPosition(
              pos => {
                const { latitude, longitude, accuracy } = pos.coords;
                latEl.textContent = latitude.toFixed(8);
                lngEl.textContent = longitude.toFixed(8);
                accEl.textContent = accuracy.toFixed(2) + 'ç±³';
                reverseGeocode(latitude, longitude);
                
                const now = new Date();
                const timeStr = now.getFullYear() + '-' +
                  String(now.getMonth() + 1).padStart(2, '0') + '-' +
                  String(now.getDate()).padStart(2, '0') + ' ' +
                  String(now.getHours()).padStart(2, '0') + ':' +
                  String(now.getMinutes()).padStart(2, '0') + ':' +
                  String(now.getSeconds()).padStart(2, '0') + '.' +
                  String(now.getMilliseconds()).padStart(3, '0');
                locationUpdateTimeEl.textContent = timeStr;
              },
              err => console.error('æŒç»­å®šä½é”™è¯¯:', err),
              {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
              }
            );
          }
        },
        err => {
          console.error('å®šä½é”™è¯¯:', err);
          
          let errorMsg = '';
          if (err.code === 1) {
            errorMsg = 'å®šä½æƒé™è¢«æ‹’ç»\n\nè¯·åœ¨è®¾å¤‡è®¾ç½®ä¸­å…è®¸æµè§ˆå™¨è®¿é—®ä½ç½®ä¿¡æ¯ï¼š\n\n';
            if (isMobile) {
              if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                errorMsg += 'iOSè®¾å¤‡ï¼š\nè®¾ç½® â†’ Safari/æµè§ˆå™¨ â†’ ä½ç½® â†’ å…è®¸\næˆ–\nè®¾ç½® â†’ éšç§ â†’ å®šä½æœåŠ¡ â†’ Safari/æµè§ˆå™¨ â†’ ä½¿ç”¨åº”ç”¨æœŸé—´';
              } else if (/Android/.test(navigator.userAgent)) {
                errorMsg += 'Androidè®¾å¤‡ï¼š\nè®¾ç½® â†’ åº”ç”¨ â†’ æµè§ˆå™¨ â†’ æƒé™ â†’ ä½ç½® â†’ å…è®¸';
              } else {
                errorMsg += 'è¯·åœ¨æµè§ˆå™¨æˆ–ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸å®šä½æƒé™';
              }
            }
            latEl.textContent = 'æƒé™è¢«æ‹’ç»';
            lngEl.textContent = 'æƒé™è¢«æ‹’ç»';
          } else if (err.code === 2) {
            errorMsg = 'æ— æ³•è·å–ä½ç½®ä¿¡æ¯\n\nå¯èƒ½çš„åŸå› ï¼š\nâ€¢ GPSä¿¡å·å¼±ï¼Œè¯·ç§»åˆ°å¼€é˜”åŒºåŸŸ\nâ€¢ å®šä½æœåŠ¡æœªå¼€å¯\nâ€¢ ç½‘ç»œè¿æ¥é—®é¢˜';
            latEl.textContent = 'ä½ç½®ä¸å¯ç”¨';
            lngEl.textContent = 'ä½ç½®ä¸å¯ç”¨';
          } else if (err.code === 3) {
            errorMsg = 'å®šä½è¯·æ±‚è¶…æ—¶\n\nè¯·æ£€æŸ¥ï¼š\nâ€¢ GPSæ˜¯å¦å¼€å¯\nâ€¢ ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\nâ€¢ æ˜¯å¦åœ¨å®¤å†…ï¼ˆå»ºè®®åˆ°å®¤å¤–å°è¯•ï¼‰';
            latEl.textContent = 'å®šä½è¶…æ—¶';
            lngEl.textContent = 'å®šä½è¶…æ—¶';
          }
          
          if (errorMsg) {
            alert(errorMsg);
          }
          
          accEl.textContent = 'â€”';
          addrEl.textContent = 'â€”';
          locationUpdateTimeEl.textContent = 'â€”';
        },
        {
          enableHighAccuracy: true,
          timeout: 20000,
          maximumAge: 0
        }
      );
    }

    // åˆå§‹åŒ–é«˜å¾·å®šä½
    initAmapGeolocation();

    // æ¯30ç§’æ›´æ–°ä¸€æ¬¡ä½ç½®ï¼ˆæ¡Œé¢ç«¯ï¼‰
    if (!isMobile) {
      setInterval(updateLocationWithAmap, 30000);
    }

    // ============== è®¾å¤‡æœå‘æ£€æµ‹ ==============
    let currentOrientation = null;
    let orientationSupported = false;

    // å¤„ç†è®¾å¤‡æœå‘äº‹ä»¶
    function handleOrientation(event) {
      if (event.alpha !== null) {
        orientationSupported = true;
        // alpha: 0-360åº¦ï¼Œè¡¨ç¤ºè®¾å¤‡ç»•Zè½´æ—‹è½¬çš„è§’åº¦ï¼ˆæ–¹ä½è§’ï¼‰
        // 0åº¦=æ­£åŒ—ï¼Œ90åº¦=æ­£ä¸œï¼Œ180åº¦=æ­£å—ï¼Œ270åº¦=æ­£è¥¿
        currentOrientation = event.alpha;
      }
    }

    // æ›´æ–°æœå‘æ˜¾ç¤ºï¼ˆæ¯2ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
    function updateOrientationDisplay() {
      if (currentOrientation !== null) {
        const alpha = currentOrientation.toFixed(1);
        let direction = '';
        
        // æ ¹æ®è§’åº¦åˆ¤æ–­æ–¹å‘
        const angle = parseFloat(alpha);
        if (angle >= 337.5 || angle < 22.5) {
          direction = 'æ­£åŒ—';
        } else if (angle >= 22.5 && angle < 67.5) {
          direction = 'ä¸œåŒ—';
        } else if (angle >= 67.5 && angle < 112.5) {
          direction = 'æ­£ä¸œ';
        } else if (angle >= 112.5 && angle < 157.5) {
          direction = 'ä¸œå—';
        } else if (angle >= 157.5 && angle < 202.5) {
          direction = 'æ­£å—';
        } else if (angle >= 202.5 && angle < 247.5) {
          direction = 'è¥¿å—';
        } else if (angle >= 247.5 && angle < 292.5) {
          direction = 'æ­£è¥¿';
        } else if (angle >= 292.5 && angle < 337.5) {
          direction = 'è¥¿åŒ—';
        }
        
        orientationEl.textContent = `${alpha}Â° (${direction})`;
      } else if (orientationSupported === false) {
        orientationEl.textContent = 'è®¾å¤‡ä¸æ”¯æŒæˆ–æœªæˆæƒ';
      }
    }

    // è¯·æ±‚è®¾å¤‡æœå‘æƒé™ï¼ˆiOS 13+éœ€è¦ï¼‰
    async function requestOrientationPermission() {
      if (typeof DeviceOrientationEvent !== 'undefined' && 
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS 13+ éœ€è¦ç”¨æˆ·äº¤äº’åè¯·æ±‚æƒé™
        try {
          const permission = await DeviceOrientationEvent.requestPermission();
          if (permission === 'granted') {
            window.addEventListener('deviceorientation', handleOrientation);
            setInterval(updateOrientationDisplay, 2000);
          } else {
            orientationEl.textContent = 'æƒé™è¢«æ‹’ç»';
          }
        } catch (error) {
          console.error('æ–¹å‘ä¼ æ„Ÿå™¨æƒé™è¯·æ±‚å¤±è´¥:', error);
          orientationEl.textContent = 'æƒé™è¯·æ±‚å¤±è´¥';
        }
      } else if (window.DeviceOrientationEvent) {
        // å…¶ä»–æµè§ˆå™¨ç›´æ¥ç›‘å¬
        window.addEventListener('deviceorientation', handleOrientation);
        setInterval(updateOrientationDisplay, 2000);
        
        // 3ç§’åæ£€æŸ¥æ˜¯å¦è·å–åˆ°æ•°æ®
        setTimeout(() => {
          if (currentOrientation === null) {
            orientationEl.textContent = 'è®¾å¤‡ä¸æ”¯æŒæœå‘æ£€æµ‹';
          }
        }, 3000);
      } else {
        orientationEl.textContent = 'æµè§ˆå™¨ä¸æ”¯æŒæœå‘æ£€æµ‹';
      }
    }

    // åˆå§‹åŒ–è®¾å¤‡æœå‘æ£€æµ‹
    requestOrientationPermission();

    // ä¸ºç§»åŠ¨ç«¯æ‰“å¼€æ‘„åƒå¤´æŒ‰é’®æ·»åŠ æƒé™è¯·æ±‚ï¼ˆiOSéœ€è¦åœ¨ç”¨æˆ·äº¤äº’ä¸­è¯·æ±‚ï¼‰
    if (openMobileBtn) {
      openMobileBtn.addEventListener('click', () => {
        if (typeof DeviceOrientationEvent !== 'undefined' && 
            typeof DeviceOrientationEvent.requestPermission === 'function' &&
            !orientationSupported) {
          // å¦‚æœè¿˜æ²¡æœ‰è¯·æ±‚è¿‡æƒé™ï¼Œåœ¨ç”¨æˆ·ç‚¹å‡»æ—¶è¯·æ±‚
          DeviceOrientationEvent.requestPermission().then(permission => {
            if (permission === 'granted') {
              window.addEventListener('deviceorientation', handleOrientation);
              setInterval(updateOrientationDisplay, 2000);
            }
          }).catch(console.error);
        }
      }, { once: true, capture: true });
    }

    // ç§»åŠ¨ç«¯ï¼šå»¶è¿Ÿ3ç§’åæ£€æŸ¥å®šä½æƒé™ï¼Œå¦‚æœå¤±è´¥åˆ™æç¤ºç”¨æˆ·
    if (isMobile) {
      setTimeout(() => {
        if (!locationPermissionGranted && 
            (latEl.textContent.includes('æœªæˆæƒ') || 
             latEl.textContent.includes('å¤±è´¥') || 
             latEl.textContent.includes('è·å–ä¸­'))) {
          // æ˜¾ç¤ºå‹å¥½æç¤º
          if (confirm('ğŸ“ æ£€æµ‹åˆ°å®šä½æœªæˆåŠŸ\n\nç‚¹å‡»ç¡®å®šä½¿ç”¨é«˜å¾·ç²¾ç¡®å®šä½ï¼Œè·å¾—æ›´å‡†ç¡®çš„ç»çº¬åº¦ä¿¡æ¯\n\nï¼ˆå»ºè®®å¼€å¯ï¼Œæ‹ç…§æ—¶å¯è®°å½•å‡†ç¡®ä½ç½®ï¼‰')) {
            requestPreciseLocation();
          }
        }
      }, 3000);
    }

    // ============== æ‹ç…§å¤„ç†å‡½æ•° ==============
    function capturePhoto(videoElement) {
      const w = videoElement.videoWidth;
      const h = videoElement.videoHeight;

      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoElement, 0, 0, w, h);

      // æ”¶é›†è¦æ˜¾ç¤ºçš„ä¿¡æ¯
      const infoLines = [];
      
      // 1. æ‹æ‘„æ—¶é—´
      const currentTime = timeEl.textContent;
      if (currentTime && currentTime !== 'â€”') {
        infoLines.push('æ‹æ‘„æ—¶é—´: ' + currentTime);
      }
      
      // 2. ç»çº¬åº¦
      const lat = latEl.textContent;
      const lng = lngEl.textContent;
      if (lat && lat !== 'è·å–ä¸­â€¦' && lat !== 'å®šä½å¤±è´¥' && lat !== 'ä¸æ”¯æŒå®šä½' && 
          lng && lng !== 'è·å–ä¸­â€¦' && lng !== 'å®šä½å¤±è´¥' && lng !== 'ä¸æ”¯æŒå®šä½') {
        infoLines.push('ç»åº¦: ' + lng);
        infoLines.push('çº¬åº¦: ' + lat);
      }
      
      // 3. å®šä½ç²¾åº¦
      const accuracy = accEl.textContent;
      if (accuracy && accuracy !== 'â€”' && accuracy !== 'å®šä½å¤±è´¥') {
        infoLines.push('å®šä½ç²¾åº¦: ' + accuracy);
      }
      
      // 4. å®šä½æœ€åæ›´æ–°æ—¶é—´
      const locationTime = locationUpdateTimeEl.textContent;
      if (locationTime && locationTime !== 'â€”') {
        infoLines.push('å®šä½æ›´æ–°: ' + locationTime);
      }
      
      // 5. æ‰€åœ¨ä½ç½®ï¼ˆå¯é€‰ï¼Œä»…åœ¨æˆåŠŸè·å–æ—¶æ˜¾ç¤ºï¼‰
      const address = addrEl.textContent;
      if (address && 
          address !== 'è§£æä¸­â€¦' && 
          address !== 'ä½ç½®è§£æå¤±è´¥' && 
          address !== 'æ— æ³•è§£æå…·ä½“ä½ç½®' && 
          address !== 'â€”' && 
          address !== 'å®šä½å¤±è´¥') {
        infoLines.push('ä½ç½®: ' + address);
      }
      
      // 6. è®¾å¤‡æœå‘ï¼ˆæ–¹ä½è§’ï¼‰
      const orientation = orientationEl.textContent;
      if (orientation && 
          orientation !== 'æ£€æµ‹ä¸­â€¦' && 
          orientation !== 'è®¾å¤‡ä¸æ”¯æŒæˆ–æœªæˆæƒ' && 
          orientation !== 'æƒé™è¢«æ‹’ç»' && 
          orientation !== 'æƒé™è¯·æ±‚å¤±è´¥' && 
          orientation !== 'è®¾å¤‡ä¸æ”¯æŒæœå‘æ£€æµ‹' && 
          orientation !== 'æµè§ˆå™¨ä¸æ”¯æŒæœå‘æ£€æµ‹' && 
          orientation !== 'â€”') {
        infoLines.push('è®¾å¤‡æœå‘: ' + orientation);
      }
      
      // 7. å¤©æ°”ä¿¡æ¯
      const weather = weatherEl.textContent;
      if (weather && 
          weather !== 'è·å–ä¸­â€¦' && 
          weather !== 'å¤©æ°”è·å–å¤±è´¥' && 
          weather !== 'æ— æ³•è·å–å¤©æ°”ä¿¡æ¯' && 
          weather !== 'â€”') {
        infoLines.push('å¤©æ°”: ' + weather);
      }

      // è®¡ç®—å­—ä½“å’Œé—´è·ï¼ˆæ›´ç´§å‡‘ï¼‰
      const fontSize = Math.max(14, w * 0.012);
      const paddingX = Math.max(12, w * 0.012);
      const paddingY = Math.max(8, h * 0.008);
      const lineHeight = fontSize * 1.3;
      
      // è®¾ç½®å­—ä½“ä»¥æµ‹é‡æ–‡å­—å®½åº¦
      ctx.font = `${fontSize}px system-ui`;
      ctx.textBaseline = 'top';
      
      // è®¡ç®—æ¯è¡Œæ–‡å­—çš„å®é™…å®½åº¦
      const textMetrics = infoLines.map(line => ctx.measureText(line).width);
      const maxTextWidth = Math.max(...textMetrics);
      
      // è®¡ç®—ç´§å‡‘çš„æ°´å°åŒºåŸŸå°ºå¯¸
      const watermarkWidth = maxTextWidth + paddingX * 2;
      const watermarkHeight = lineHeight * infoLines.length + paddingY * 2;
      
      // æ°´å°ä½ç½®ï¼ˆå·¦ä¸‹è§’ï¼Œæ›´é è¾¹ï¼‰
      const watermarkX = paddingX * 0.5;
      const watermarkY = h - watermarkHeight - paddingY * 0.5;
      
      // ç»˜åˆ¶æ›´æ·¡çš„åœ†è§’çŸ©å½¢èƒŒæ™¯
      ctx.fillStyle = 'rgba(0,0,0,0.5)';
      const radius = Math.min(8, fontSize * 0.5);
      ctx.beginPath();
      ctx.moveTo(watermarkX + radius, watermarkY);
      ctx.lineTo(watermarkX + watermarkWidth - radius, watermarkY);
      ctx.quadraticCurveTo(watermarkX + watermarkWidth, watermarkY, watermarkX + watermarkWidth, watermarkY + radius);
      ctx.lineTo(watermarkX + watermarkWidth, watermarkY + watermarkHeight - radius);
      ctx.quadraticCurveTo(watermarkX + watermarkWidth, watermarkY + watermarkHeight, watermarkX + watermarkWidth - radius, watermarkY + watermarkHeight);
      ctx.lineTo(watermarkX + radius, watermarkY + watermarkHeight);
      ctx.quadraticCurveTo(watermarkX, watermarkY + watermarkHeight, watermarkX, watermarkY + watermarkHeight - radius);
      ctx.lineTo(watermarkX, watermarkY + radius);
      ctx.quadraticCurveTo(watermarkX, watermarkY, watermarkX + radius, watermarkY);
      ctx.closePath();
      ctx.fill();

      // ç»˜åˆ¶æ–‡å­—ï¼ˆç™½è‰²ï¼Œå¸¦é˜´å½±å¢å¼ºå¯è¯»æ€§ï¼‰
      ctx.fillStyle = '#fff';
      ctx.shadowColor = 'rgba(0,0,0,0.8)';
      ctx.shadowBlur = 3;
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;

      // é€è¡Œç»˜åˆ¶ä¿¡æ¯
      infoLines.forEach((line, index) => {
        const x = watermarkX + paddingX;
        const y = watermarkY + paddingY + (lineHeight * index);
        ctx.fillText(line, x, y);
      });
      
      // é‡ç½®é˜´å½±
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;

      return canvas.toDataURL('image/jpeg', 0.95);
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    // ============== æ¡Œé¢ç«¯æ‘„åƒå¤´æ§åˆ¶ ==============
    openBtn.onclick = async () => {
      if (stream) return;

      // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®\n\nè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Edgeã€Safariç­‰ï¼‰');
        return;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });

        video.srcObject = stream;
        takeBtn.style.display = 'block';
        openBtn.textContent = 'æ‘„åƒå¤´å·²å¼€å¯';
        openBtn.disabled = true;
      } catch (e) {
        openBtn.textContent = 'é‡æ–°æ‰“å¼€æ‘„åƒå¤´';
        openBtn.disabled = false;
        
        let errorMsg = '';
        if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
          errorMsg = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»\n\nè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ­¤ç½‘ç«™è®¿é—®æ‘„åƒå¤´ï¼š\n1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„å›¾æ ‡\n2. æ‰¾åˆ°æ‘„åƒå¤´æƒé™è®¾ç½®\n3. é€‰æ‹©"å…è®¸"æˆ–"å§‹ç»ˆå…è®¸"\n4. åˆ·æ–°é¡µé¢åé‡è¯•';
        } else if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError') {
          errorMsg = 'æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡\n\nè¯·ç¡®è®¤ï¼š\n1. è®¾å¤‡æ˜¯å¦æœ‰æ‘„åƒå¤´\n2. æ‘„åƒå¤´æ˜¯å¦å·²æ­£ç¡®è¿æ¥\n3. å…¶ä»–åº”ç”¨æ˜¯å¦æ­£åœ¨ä½¿ç”¨æ‘„åƒå¤´';
        } else if (e.name === 'NotReadableError' || e.name === 'TrackStartError') {
          errorMsg = 'æ‘„åƒå¤´æ— æ³•å¯åŠ¨\n\nå¯èƒ½çš„åŸå› ï¼š\n1. æ‘„åƒå¤´æ­£è¢«å…¶ä»–åº”ç”¨å ç”¨\n2. ç¡¬ä»¶é”™è¯¯\n\nè¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨åé‡è¯•';
        } else if (e.name === 'OverconstrainedError' || e.name === 'ConstraintNotSatisfiedError') {
          errorMsg = 'æ‘„åƒå¤´ä¸æ”¯æŒè¯·æ±‚çš„é…ç½®\n\nå°è¯•ä½¿ç”¨é»˜è®¤è®¾ç½®...';
          
          // å°è¯•ä½¿ç”¨æ›´å®½æ¾çš„é…ç½®
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: false
            });
            video.srcObject = stream;
            takeBtn.style.display = 'block';
            openBtn.textContent = 'æ‘„åƒå¤´å·²å¼€å¯';
            openBtn.disabled = true;
            return;
          } catch (retryError) {
            errorMsg = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥\n\nå³ä½¿ä½¿ç”¨é»˜è®¤é…ç½®ä¹Ÿæ— æ³•å¯åŠ¨æ‘„åƒå¤´';
          }
        } else if (e.name === 'TypeError') {
          errorMsg = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®\n\nè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Edgeã€Safariç­‰ï¼‰';
        } else {
          errorMsg = 'æ‘„åƒå¤´è®¿é—®å¤±è´¥\n\né”™è¯¯ç±»å‹: ' + e.name + '\né”™è¯¯ä¿¡æ¯: ' + e.message;
        }
        
        alert(errorMsg);
      }
    };

    takeBtn.onclick = () => {
      if (!stream) return;

      const url = capturePhoto(video);

      preview.src = url;
      preview.style.display = 'block';
      previewContainer.querySelector('.placeholder').style.display = 'none';

      // æ¡Œé¢ç«¯ï¼šè½¬æ¢ä¸ºBlob URLä»¥æ”¯æŒæ›´å¥½çš„ä¸‹è½½
      try {
        const arr = url.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        const blob = new Blob([u8arr], { type: mime });
        const blobUrl = URL.createObjectURL(blob);
        
        download.href = blobUrl;
        download.download = `ç»çº¬ç›¸æœº_${Date.now()}.jpg`;
        download.style.display = 'inline-block';
      } catch (e) {
        download.href = url;
        download.download = `ç»çº¬ç›¸æœº_${Date.now()}.jpg`;
        download.style.display = 'inline-block';
      }
    };

    // ============== ç§»åŠ¨ç«¯æ‘„åƒå¤´æ§åˆ¶ ==============
    openMobileBtn.onclick = async () => {
      // ç§»åŠ¨ç«¯ï¼šå…ˆè¯·æ±‚ç²¾ç¡®å®šä½æƒé™
      if (isMobile && !locationPermissionGranted) {
        const confirmLocation = confirm('æ£€æµ‹åˆ°æ‚¨æ˜¯ç§»åŠ¨è®¾å¤‡\n\næ˜¯å¦ä½¿ç”¨é«˜å¾·ç²¾ç¡®å®šä½ä»¥è·å¾—æ›´å‡†ç¡®çš„ä½ç½®ä¿¡æ¯ï¼Ÿ\n\nï¼ˆæ¨èå¼€å¯ï¼Œé«˜å¾·å®šä½æ¯”æµè§ˆå™¨å®šä½æ›´å‡†ç¡®ï¼‰');
        if (confirmLocation) {
          requestPreciseLocation();
          // ç­‰å¾…ä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°å®šä½ç»“æœ
          await new Promise(resolve => setTimeout(resolve, 1500));
        }
      }

      // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®\n\nè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨æˆ–å‡çº§å½“å‰æµè§ˆå™¨ç‰ˆæœ¬');
        return;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });

        mobileVideo.srcObject = stream;
        mobileCameraMode.classList.add('active');
      } catch (e) {
        let errorMsg = '';
        if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
          errorMsg = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»\n\nè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ­¤ç½‘ç«™è®¿é—®æ‘„åƒå¤´ï¼š\n1. ç‚¹å‡»åœ°å€æ çš„è®¾ç½®å›¾æ ‡\n2. æ‰¾åˆ°"æ‘„åƒå¤´"æˆ–"ç›¸æœº"æƒé™\n3. é€‰æ‹©"å…è®¸"\n4. åˆ·æ–°é¡µé¢åé‡è¯•\n\nå¦‚ä½¿ç”¨Viaæµè§ˆå™¨ç­‰ï¼š\nè®¾ç½® â†’ éšç§ â†’ ç½‘ç«™æƒé™ â†’ æ‘„åƒå¤´ â†’ å…è®¸';
        } else if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError') {
          errorMsg = 'æœªæ£€æµ‹åˆ°æ‘„åƒå¤´\n\nè¯·ç¡®è®¤è®¾å¤‡æ‘„åƒå¤´æ˜¯å¦å¯ç”¨';
        } else if (e.name === 'NotReadableError' || e.name === 'TrackStartError') {
          errorMsg = 'æ‘„åƒå¤´è¢«å ç”¨\n\nè¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨åé‡è¯•';
        } else if (e.name === 'OverconstrainedError' || e.name === 'ConstraintNotSatisfiedError') {
          errorMsg = 'æ‘„åƒå¤´ä¸æ”¯æŒå½“å‰é…ç½®\n\nå°è¯•ä½¿ç”¨é»˜è®¤è®¾ç½®...';
          
          // å°è¯•ä½¿ç”¨æ›´å®½æ¾çš„é…ç½®
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: false
            });
            mobileVideo.srcObject = stream;
            mobileCameraMode.classList.add('active');
            return;
          } catch (retryError) {
            errorMsg = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥\n\nå³ä½¿ä½¿ç”¨é»˜è®¤é…ç½®ä¹Ÿæ— æ³•å¯åŠ¨';
          }
        } else if (e.name === 'TypeError') {
          errorMsg = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®\n\nè¯·å‡çº§æµè§ˆå™¨æˆ–ä½¿ç”¨å…¶ä»–ç°ä»£æµè§ˆå™¨';
        } else {
          errorMsg = 'æ‘„åƒå¤´è®¿é—®å¤±è´¥\n\né”™è¯¯: ' + e.name + '\n' + e.message;
        }
        
        alert(errorMsg);
      }
    };

    closeMobileCamera.onclick = () => {
      mobileCameraMode.classList.remove('active');
      stopCamera();
    };

    mobileShutter.onclick = () => {
      if (!stream) return;

      const url = capturePhoto(mobileVideo);
      photoPreviewImg.src = url;

      mobileCameraMode.classList.remove('active');
      photoPreviewMode.classList.add('active');
      
      // é‡æ–°è§¦å‘æç¤ºåŠ¨ç”»
      longPressTip.style.animation = 'none';
      setTimeout(() => {
        longPressTip.style.animation = 'fadeInOut 3s ease-in-out';
      }, 10);
    };

    cancelPhoto.onclick = () => {
      photoPreviewMode.classList.remove('active');
      mobileCameraMode.classList.add('active');
      
      // é‡ç½®æç¤ºåŠ¨ç”»
      longPressTip.style.animation = 'none';
    };

    savePhoto.onclick = () => {
      const url = photoPreviewImg.src;
      
      try {
        // ç§»åŠ¨ç«¯ï¼šå°†dataURLè½¬æ¢ä¸ºBlobå†ä¸‹è½½
        const arr = url.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        const blob = new Blob([u8arr], { type: mime });
        
        // åˆ›å»ºBlob URL
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = `ç»çº¬ç›¸æœº_${Date.now()}.jpg`;
        a.style.display = 'none';
        
        // æ·»åŠ åˆ°DOMï¼Œè§¦å‘ç‚¹å‡»ï¼Œç„¶åç§»é™¤
        document.body.appendChild(a);
        a.click();
        
        // å»¶è¿Ÿæ¸…ç†
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(blobUrl);
        }, 100);
        
        photoPreviewMode.classList.remove('active');
        stopCamera();
        
        // é‡ç½®æç¤ºåŠ¨ç”»
        longPressTip.style.animation = 'none';
        
      } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        // å¦‚æœè‡ªåŠ¨ä¸‹è½½å¤±è´¥ï¼Œæä¾›å¤‡ç”¨æ–¹æ¡ˆï¼Œä½†ä¸å…³é—­é¢„è§ˆ
        alert('è‡ªåŠ¨ä¸‹è½½å¤±è´¥\n\nè¯·é•¿æŒ‰ç…§ç‰‡ï¼Œåœ¨å¼¹å‡ºèœå•ä¸­é€‰æ‹©"ä¿å­˜å›¾ç‰‡"æˆ–"ä¸‹è½½å›¾ç‰‡"');
        // ä¸å…³é—­é¢„è§ˆç•Œé¢ï¼Œè®©ç”¨æˆ·å¯ä»¥é•¿æŒ‰ä¿å­˜
      }
    };

    // ============== å“åº”å¼å¤„ç† ==============
    window.addEventListener('resize', () => {
      isMobile = window.innerWidth <= 768;
    });

    // é¡µé¢å¸è½½æ—¶å…³é—­æ‘„åƒå¤´å’Œå®šä½ç›‘å¬
    window.addEventListener('beforeunload', () => {
      stopCamera();
      if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
      }
      if (amapLocationTimer) {
        clearInterval(amapLocationTimer);
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç»çº¬ç›¸æœº</title>
  <link rel="icon" href="./logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    :root {
      --bg: #0f1115;
      --card: #161a22;
      --text-main: #e6e8ee;
      --text-sub: #9aa0ad;
      --accent: #4da3ff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 50% -200px, #1b2130, var(--bg));
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    /* ============== ç§»åŠ¨ç«¯å…¨å±æ‹ç…§æ¨¡å¼ ============== */
    .mobile-camera-mode {
      display: none;
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 9999;
      flex-direction: column;
    }

    .mobile-camera-mode.active {
      display: flex;
    }

    .mobile-camera-video {
      flex: 1;
      width: 100%;
      object-fit: contain;
    }

    .mobile-camera-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      height: 120px;
    }

    .shutter-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: #fff;
      border: 4px solid rgba(255,255,255,0.3);
      cursor: pointer;
      transition: transform 0.1s;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .shutter-btn img {
      width: 60%;
      height: 60%;
      object-fit: contain;
      pointer-events: none;
    }

    .shutter-btn:active {
      transform: scale(0.9);
    }

    .close-camera-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 40px;
      height: 40px;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    /* æ‹ç…§åçš„é¢„è§ˆå’Œä¿å­˜ç•Œé¢ */
    .photo-preview-mode {
      display: none;
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 10000;
      flex-direction: column;
    }

    .photo-preview-mode.active {
      display: flex;
    }

    .photo-preview-img {
      flex: 1;
      width: 100%;
      object-fit: contain;
    }

    .long-press-tip {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      pointer-events: none;
      z-index: 10;
      animation: fadeInOut 3s ease-in-out;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }

    .photo-preview-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      display: flex;
      justify-content: space-around;
      align-items: center;
      gap: 15px;
      height: 100px;
    }

    .preview-btn {
      flex: 1;
      padding: 14px 20px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .preview-btn:active {
      transform: scale(0.95);
    }

    .preview-btn.cancel {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }

    .preview-btn.save {
      background: var(--accent);
      color: #000;
    }

    /* ============== æ¡Œé¢ç«¯å¸ƒå±€ ============== */
    .desktop-container {
      height: 100vh;
      width: 100vw;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: clamp(10px, 1.5vw, 20px);
      padding: clamp(10px, 1.5vw, 20px);
    }

    .panel {
      background: linear-gradient(180deg, #1a1f2b, var(--card));
      border-radius: clamp(12px, 1vw, 16px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
      padding: clamp(16px, 2vw, 28px);
      overflow: auto;
      display: flex;
      flex-direction: column;
    }

    .info-panel {
      grid-row: 1 / 3;
    }

    .camera-panel {
      display: flex;
      flex-direction: column;
      gap: clamp(10px, 1vw, 15px);
    }

    .preview-panel {
      display: flex;
      flex-direction: column;
    }

    .title {
      font-size: clamp(14px, 1.2vw, 18px);
      letter-spacing: 0.08em;
      color: var(--text-sub);
      margin-bottom: clamp(12px, 1.5vw, 20px);
      flex-shrink: 0;
    }

    .block {
      margin-bottom: clamp(10px, 1.2vw, 16px);
      flex-shrink: 0;
    }

    .label {
      font-size: clamp(10px, 0.8vw, 12px);
      color: var(--text-sub);
      margin-bottom: clamp(4px, 0.5vw, 6px);
    }

    .value {
      font-size: clamp(16px, 1.5vw, 22px);
      font-weight: 600;
      line-height: 1.3;
      word-break: break-all;
    }

    .value.small {
      font-size: clamp(12px, 1vw, 15px);
      font-weight: 500;
      color: var(--text-sub);
    }

    .time {
      padding-top: clamp(10px, 1vw, 18px);
      border-top: 1px solid rgba(255,255,255,0.06);
    }

    .time .value {
      font-size: clamp(16px, 1.6vw, 24px);
      color: var(--accent);
      font-variant-numeric: tabular-nums;
    }

    .btn {
      width: 100%;
      padding: clamp(10px, 1vw, 14px) 0;
      border-radius: clamp(8px, 0.8vw, 12px);
      border: none;
      font-size: clamp(13px, 1vw, 15px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .btn.primary {
      background: #ffffff;
      color: #0f1115;
    }

    .btn.secondary {
      background: #2b3142;
      color: var(--text-main);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .video-container {
      width: 100%;
      flex: 1;
      background: #000;
      border-radius: clamp(10px, 1vw, 14px);
      overflow: hidden;
      min-height: 0;
      position: relative;
    }

    .video-container video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .preview-container {
      width: 100%;
      flex: 1;
      background: #000;
      border-radius: clamp(10px, 1vw, 14px);
      overflow: hidden;
      min-height: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .preview-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .preview-container .placeholder {
      color: var(--text-sub);
      font-size: clamp(12px, 1vw, 14px);
    }

    .download-link {
      display: inline-block;
      margin-top: clamp(8px, 0.8vw, 12px);
      padding: clamp(8px, 0.8vw, 12px) clamp(16px, 1.5vw, 24px);
      background: linear-gradient(135deg, var(--accent), #3d8fe8);
      color: #0f1115;
      font-size: clamp(12px, 1vw, 14px);
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      flex-shrink: 0;
      border-radius: clamp(6px, 0.6vw, 8px);
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(77, 163, 255, 0.3);
    }

    canvas {
      display: none;
    }

    /* ============== ç§»åŠ¨ç«¯å¸ƒå±€ ============== */
    @media (max-width: 768px) {
      body {
        overflow: auto;
      }

      .desktop-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: auto;
        min-height: 100vh;
        padding: 20px;
      }

      .panel {
        width: 100%;
        margin-bottom: 0;
      }

      .info-panel {
        display: block;
        text-align: center;
      }
      
      .info-panel .label {
        text-align: center;
      }
      
      .info-panel .value {
        text-align: center;
      }

      .camera-panel,
      .preview-panel {
        display: none;
      }

      .mobile-only {
        display: block !important;
      }

      .desktop-only {
        display: none !important;
      }

      .value {
        font-size: 20px;
      }

      .value.small {
        font-size: 14px;
      }

      .time .value {
        font-size: 22px;
      }

      .btn {
        padding: 14px 0;
        font-size: 16px;
      }
    }

    .mobile-only {
      display: none;
    }
  </style>
</head>
<body>
  <!-- ç§»åŠ¨ç«¯å…¨å±æ‹ç…§æ¨¡å¼ -->
  <div class="mobile-camera-mode" id="mobileCameraMode">
    <button class="close-camera-btn" id="closeMobileCamera">Ã—</button>
    <video class="mobile-camera-video" id="mobileVideo" autoplay playsinline muted></video>
    <div class="mobile-camera-controls">
      <button class="shutter-btn" id="mobileShutter">
        <img src="./photo.png" alt="æ‹ç…§">
      </button>
    </div>
  </div>

  <!-- ç§»åŠ¨ç«¯æ‹ç…§é¢„è§ˆæ¨¡å¼ -->
  <div class="photo-preview-mode" id="photoPreviewMode">
    <div class="long-press-tip" id="longPressTip">ğŸ’¡ é•¿æŒ‰å›¾ç‰‡ä¹Ÿå¯ä¿å­˜</div>
    <img class="photo-preview-img" id="photoPreviewImg" alt="æ‹ç…§é¢„è§ˆ">
    <div class="photo-preview-controls">
      <button class="preview-btn cancel" id="cancelPhoto">é‡æ‹</button>
      <button class="preview-btn save" id="savePhoto">ä¿å­˜ç…§ç‰‡</button>
    </div>
  </div>

  <!-- æ¡Œé¢ç«¯/ç§»åŠ¨ç«¯ä¸»ç•Œé¢ -->
  <div class="desktop-container">
    <!-- åœ°ç†ä½ç½®å’Œæ—¶é—´ä¿¡æ¯ -->
    <div class="panel info-panel">
      <div class="title">LOCATION & TIME</div>

      <div class="block">
        <div class="label">çº¬åº¦</div>
        <div class="value" id="latitude">è·å–ä¸­â€¦</div>
      </div>

      <div class="block">
        <div class="label">ç»åº¦</div>
        <div class="value" id="longitude">è·å–ä¸­â€¦</div>
      </div>

      <div class="block">
        <div class="label">æ‰€åœ¨ä½ç½®</div>
        <div class="value small" id="address">è§£æä¸­â€¦</div>
      </div>

      <div class="block">
        <div class="label">å®šä½ç²¾åº¦</div>
        <div class="value small" id="accuracy">â€”</div>
      </div>

      <div class="block">
        <div class="label">å®šä½æœ€åæ›´æ–°æ—¶é—´</div>
        <div class="value small" id="locationUpdateTime">â€”</div>
      </div>

      <div class="block time">
        <div class="label">å½“å‰æ—¶é—´</div>
        <div class="value" id="time">â€”</div>
      </div>

      <!-- ç§»åŠ¨ç«¯ä¸“ç”¨æŒ‰é’® -->
      <div class="block mobile-only" style="margin-top: 20px;">
        <button class="btn primary" id="openMobileCamera">æ‰“å¼€æ‘„åƒå¤´</button>
      </div>

      <!-- æ¡Œé¢ç«¯ä¸“ç”¨æŒ‰é’® -->
      <div class="block desktop-only" style="margin-top: 20px;">
        <button class="btn secondary" id="openCamera">æ‰“å¼€æ‘„åƒå¤´</button>
      </div>
      <div class="block desktop-only">
        <button class="btn primary" id="takePhoto" style="display: none;">æ‹ç…§</button>
      </div>
    </div>

    <!-- æ‘„åƒå¤´å–æ™¯ -->
    <div class="panel camera-panel desktop-only">
      <div class="title">CAMERA</div>
      <div class="video-container">
        <video id="video" autoplay playsinline muted></video>
      </div>
    </div>

    <!-- ç…§ç‰‡é¢„è§ˆ -->
    <div class="panel preview-panel desktop-only">
      <div class="title">PREVIEW</div>
      <div class="preview-container" id="previewContainer">
        <div class="placeholder">ç…§ç‰‡é¢„è§ˆåŒºåŸŸ</div>
        <img id="preview" style="display: none;" alt="ç…§ç‰‡é¢„è§ˆ">
      </div>
      <a class="download-link" id="download" style="display: none;">ä¸‹è½½å›¾ç‰‡</a>
    </div>
  </div>

  <canvas id="canvas"></canvas>

  <script>
    // ============== åŸºç¡€å˜é‡ ==============
    const latEl = document.getElementById('latitude');
    const lngEl = document.getElementById('longitude');
    const accEl = document.getElementById('accuracy');
    const timeEl = document.getElementById('time');
    const addrEl = document.getElementById('address');
    const locationUpdateTimeEl = document.getElementById('locationUpdateTime');

    // æ¡Œé¢ç«¯å…ƒç´ 
    const video = document.getElementById('video');
    const openBtn = document.getElementById('openCamera');
    const takeBtn = document.getElementById('takePhoto');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('previewContainer');
    const download = document.getElementById('download');

    // ç§»åŠ¨ç«¯å…ƒç´ 
    const openMobileBtn = document.getElementById('openMobileCamera');
    const mobileCameraMode = document.getElementById('mobileCameraMode');
    const mobileVideo = document.getElementById('mobileVideo');
    const closeMobileCamera = document.getElementById('closeMobileCamera');
    const mobileShutter = document.getElementById('mobileShutter');
    const photoPreviewMode = document.getElementById('photoPreviewMode');
    const photoPreviewImg = document.getElementById('photoPreviewImg');
    const cancelPhoto = document.getElementById('cancelPhoto');
    const savePhoto = document.getElementById('savePhoto');
    const longPressTip = document.getElementById('longPressTip');

    let stream = null;
    let isMobile = window.innerWidth <= 768;

    // ============== æ£€æŸ¥æ‘„åƒå¤´æ”¯æŒ ==============
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      console.warn('æ­¤æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´API');
      if (openBtn) {
        openBtn.disabled = true;
        openBtn.textContent = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´';
      }
      if (openMobileBtn) {
        openMobileBtn.disabled = true;
        openMobileBtn.textContent = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´';
      }
    }

    // ============== æ—¶é—´æ›´æ–° ==============
    function updateTime() {
      const n = new Date();
      timeEl.textContent =
        n.getFullYear() + '-' +
        String(n.getMonth() + 1).padStart(2, '0') + '-' +
        String(n.getDate()).padStart(2, '0') + ' ' +
        String(n.getHours()).padStart(2, '0') + ':' +
        String(n.getMinutes()).padStart(2, '0') + ':' +
        String(n.getSeconds()).padStart(2, '0') + '.' +
        String(n.getMilliseconds()).padStart(3, '0');
    }

    setInterval(updateTime, 10);
    updateTime();

    // ============== åœ°ç†ä½ç½®åå‘è§£æ ==============
    function reverseGeocode(lat, lon) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=zh-CN`;

      fetch(url, {
        headers: {
          'User-Agent': 'location-demo'
        }
      })
        .then(res => res.json())
        .then(data => {
          if (data.display_name) {
            addrEl.textContent = data.display_name;
          } else {
            addrEl.textContent = 'æ— æ³•è§£æå…·ä½“ä½ç½®';
          }
        })
        .catch(() => {
          addrEl.textContent = 'ä½ç½®è§£æå¤±è´¥';
        });
    }

    // ============== è·å–åœ°ç†ä½ç½® ==============
    function updateLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const { latitude, longitude, accuracy } = pos.coords;
            latEl.textContent = latitude.toFixed(8);
            lngEl.textContent = longitude.toFixed(8);
            accEl.textContent = accuracy.toFixed(2) + 'ç±³';
            reverseGeocode(latitude, longitude);
            
            // æ›´æ–°å®šä½æ—¶é—´
            const now = new Date();
            const timeStr = now.getFullYear() + '-' +
              String(now.getMonth() + 1).padStart(2, '0') + '-' +
              String(now.getDate()).padStart(2, '0') + ' ' +
              String(now.getHours()).padStart(2, '0') + ':' +
              String(now.getMinutes()).padStart(2, '0') + ':' +
              String(now.getSeconds()).padStart(2, '0') + '.' +
              String(now.getMilliseconds()).padStart(3, '0');
            locationUpdateTimeEl.textContent = timeStr;
          },
          err => {
          if (!latEl)
            latEl.textContent = 'å®šä½å¤±è´¥';
          if (!lngEl)
            lngEl.textContent = 'å®šä½å¤±è´¥';
          if (!accEl)
            accEl.textContent = 'å®šä½å¤±è´¥';
          if (!addrEl)
            addrEl.textContent = 'â€”';
          if (!locationUpdateTimeEl) {
            locationUpdateTimeEl.textContent = 'â€”';
          }
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      } else {
        latEl.textContent = 'ä¸æ”¯æŒå®šä½';
        lngEl.textContent = 'ä¸æ”¯æŒå®šä½';
        addrEl.textContent = 'â€”';
        if (locationUpdateTimeEl) {
          locationUpdateTimeEl.textContent = 'â€”';
        }
      }
    }

    // é¦–æ¬¡è·å–ä½ç½®
    updateLocation();

    // æ¯30ç§’æ›´æ–°ä¸€æ¬¡ä½ç½®
    setInterval(updateLocation, 30000);

    // ============== æ‹ç…§å¤„ç†å‡½æ•° ==============
    function capturePhoto(videoElement) {
      const w = videoElement.videoWidth;
      const h = videoElement.videoHeight;

      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoElement, 0, 0, w, h);

      // åº•éƒ¨æ°´å°èƒŒæ™¯
      const watermarkHeight = Math.max(96, h * 0.08);
      ctx.fillStyle = 'rgba(0,0,0,0.65)';
      ctx.fillRect(0, h - watermarkHeight, w, watermarkHeight);

      ctx.fillStyle = '#fff';
      const fontSize = Math.max(16, w * 0.015);
      ctx.font = `${fontSize}px system-ui`;
      ctx.textBaseline = 'top';

      const timeText = timeEl.textContent;
      const locationText = addrEl.textContent || '';

      const padding = Math.max(20, w * 0.02);
      const lineHeight = fontSize * 1.6;

      ctx.fillText(timeText, padding, h - watermarkHeight + padding);
      ctx.fillText(locationText, padding, h - watermarkHeight + padding + lineHeight);

      return canvas.toDataURL('image/jpeg', 0.95);
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    // ============== æ¡Œé¢ç«¯æ‘„åƒå¤´æ§åˆ¶ ==============
    openBtn.onclick = async () => {
      if (stream) return;

      // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®\n\nè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Edgeã€Safariç­‰ï¼‰');
        return;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });

        video.srcObject = stream;
        takeBtn.style.display = 'block';
        openBtn.textContent = 'æ‘„åƒå¤´å·²å¼€å¯';
        openBtn.disabled = true;
      } catch (e) {
        openBtn.textContent = 'é‡æ–°æ‰“å¼€æ‘„åƒå¤´';
        openBtn.disabled = false;
        
        let errorMsg = '';
        if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
          errorMsg = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»\n\nè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ­¤ç½‘ç«™è®¿é—®æ‘„åƒå¤´ï¼š\n1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„å›¾æ ‡\n2. æ‰¾åˆ°æ‘„åƒå¤´æƒé™è®¾ç½®\n3. é€‰æ‹©"å…è®¸"æˆ–"å§‹ç»ˆå…è®¸"\n4. åˆ·æ–°é¡µé¢åé‡è¯•';
        } else if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError') {
          errorMsg = 'æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡\n\nè¯·ç¡®è®¤ï¼š\n1. è®¾å¤‡æ˜¯å¦æœ‰æ‘„åƒå¤´\n2. æ‘„åƒå¤´æ˜¯å¦å·²æ­£ç¡®è¿æ¥\n3. å…¶ä»–åº”ç”¨æ˜¯å¦æ­£åœ¨ä½¿ç”¨æ‘„åƒå¤´';
        } else if (e.name === 'NotReadableError' || e.name === 'TrackStartError') {
          errorMsg = 'æ‘„åƒå¤´æ— æ³•å¯åŠ¨\n\nå¯èƒ½çš„åŸå› ï¼š\n1. æ‘„åƒå¤´æ­£è¢«å…¶ä»–åº”ç”¨å ç”¨\n2. ç¡¬ä»¶é”™è¯¯\n\nè¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨åé‡è¯•';
        } else if (e.name === 'OverconstrainedError' || e.name === 'ConstraintNotSatisfiedError') {
          errorMsg = 'æ‘„åƒå¤´ä¸æ”¯æŒè¯·æ±‚çš„é…ç½®\n\nå°è¯•ä½¿ç”¨é»˜è®¤è®¾ç½®...';
          
          // å°è¯•ä½¿ç”¨æ›´å®½æ¾çš„é…ç½®
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: false
            });
            video.srcObject = stream;
            takeBtn.style.display = 'block';
            openBtn.textContent = 'æ‘„åƒå¤´å·²å¼€å¯';
            openBtn.disabled = true;
            return;
          } catch (retryError) {
            errorMsg = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥\n\nå³ä½¿ä½¿ç”¨é»˜è®¤é…ç½®ä¹Ÿæ— æ³•å¯åŠ¨æ‘„åƒå¤´';
          }
        } else if (e.name === 'TypeError') {
          errorMsg = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®\n\nè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Edgeã€Safariç­‰ï¼‰';
        } else {
          errorMsg = 'æ‘„åƒå¤´è®¿é—®å¤±è´¥\n\né”™è¯¯ç±»å‹: ' + e.name + '\né”™è¯¯ä¿¡æ¯: ' + e.message;
        }
        
        alert(errorMsg);
      }
    };

    takeBtn.onclick = () => {
      if (!stream) return;

      const url = capturePhoto(video);

      preview.src = url;
      preview.style.display = 'block';
      previewContainer.querySelector('.placeholder').style.display = 'none';

      // æ¡Œé¢ç«¯ï¼šè½¬æ¢ä¸ºBlob URLä»¥æ”¯æŒæ›´å¥½çš„ä¸‹è½½
      try {
        const arr = url.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        const blob = new Blob([u8arr], { type: mime });
        const blobUrl = URL.createObjectURL(blob);
        
        download.href = blobUrl;
        download.download = `ç»çº¬ç›¸æœº_${Date.now()}.jpg`;
        download.style.display = 'inline-block';
      } catch (e) {
        download.href = url;
        download.download = `ç»çº¬ç›¸æœº_${Date.now()}.jpg`;
        download.style.display = 'inline-block';
      }
    };

    // ============== ç§»åŠ¨ç«¯æ‘„åƒå¤´æ§åˆ¶ ==============
    openMobileBtn.onclick = async () => {
      // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®\n\nè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨æˆ–å‡çº§å½“å‰æµè§ˆå™¨ç‰ˆæœ¬');
        return;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });

        mobileVideo.srcObject = stream;
        mobileCameraMode.classList.add('active');
      } catch (e) {
        let errorMsg = '';
        if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
          errorMsg = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»\n\nè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ­¤ç½‘ç«™è®¿é—®æ‘„åƒå¤´ï¼š\n1. ç‚¹å‡»åœ°å€æ çš„è®¾ç½®å›¾æ ‡\n2. æ‰¾åˆ°"æ‘„åƒå¤´"æˆ–"ç›¸æœº"æƒé™\n3. é€‰æ‹©"å…è®¸"\n4. åˆ·æ–°é¡µé¢åé‡è¯•\n\nå¦‚ä½¿ç”¨Viaæµè§ˆå™¨ç­‰ï¼š\nè®¾ç½® â†’ éšç§ â†’ ç½‘ç«™æƒé™ â†’ æ‘„åƒå¤´ â†’ å…è®¸';
        } else if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError') {
          errorMsg = 'æœªæ£€æµ‹åˆ°æ‘„åƒå¤´\n\nè¯·ç¡®è®¤è®¾å¤‡æ‘„åƒå¤´æ˜¯å¦å¯ç”¨';
        } else if (e.name === 'NotReadableError' || e.name === 'TrackStartError') {
          errorMsg = 'æ‘„åƒå¤´è¢«å ç”¨\n\nè¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨åé‡è¯•';
        } else if (e.name === 'OverconstrainedError' || e.name === 'ConstraintNotSatisfiedError') {
          errorMsg = 'æ‘„åƒå¤´ä¸æ”¯æŒå½“å‰é…ç½®\n\nå°è¯•ä½¿ç”¨é»˜è®¤è®¾ç½®...';
          
          // å°è¯•ä½¿ç”¨æ›´å®½æ¾çš„é…ç½®
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: false
            });
            mobileVideo.srcObject = stream;
            mobileCameraMode.classList.add('active');
            return;
          } catch (retryError) {
            errorMsg = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥\n\nå³ä½¿ä½¿ç”¨é»˜è®¤é…ç½®ä¹Ÿæ— æ³•å¯åŠ¨';
          }
        } else if (e.name === 'TypeError') {
          errorMsg = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®\n\nè¯·å‡çº§æµè§ˆå™¨æˆ–ä½¿ç”¨å…¶ä»–ç°ä»£æµè§ˆå™¨';
        } else {
          errorMsg = 'æ‘„åƒå¤´è®¿é—®å¤±è´¥\n\né”™è¯¯: ' + e.name + '\n' + e.message;
        }
        
        alert(errorMsg);
      }
    };

    closeMobileCamera.onclick = () => {
      mobileCameraMode.classList.remove('active');
      stopCamera();
    };

    mobileShutter.onclick = () => {
      if (!stream) return;

      const url = capturePhoto(mobileVideo);
      photoPreviewImg.src = url;

      mobileCameraMode.classList.remove('active');
      photoPreviewMode.classList.add('active');
      
      // é‡æ–°è§¦å‘æç¤ºåŠ¨ç”»
      longPressTip.style.animation = 'none';
      setTimeout(() => {
        longPressTip.style.animation = 'fadeInOut 3s ease-in-out';
      }, 10);
    };

    cancelPhoto.onclick = () => {
      photoPreviewMode.classList.remove('active');
      mobileCameraMode.classList.add('active');
      
      // é‡ç½®æç¤ºåŠ¨ç”»
      longPressTip.style.animation = 'none';
    };

    savePhoto.onclick = () => {
      const url = photoPreviewImg.src;
      
      try {
        // ç§»åŠ¨ç«¯ï¼šå°†dataURLè½¬æ¢ä¸ºBlobå†ä¸‹è½½
        const arr = url.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        const blob = new Blob([u8arr], { type: mime });
        
        // åˆ›å»ºBlob URL
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = `ç»çº¬ç›¸æœº_${Date.now()}.jpg`;
        a.style.display = 'none';
        
        // æ·»åŠ åˆ°DOMï¼Œè§¦å‘ç‚¹å‡»ï¼Œç„¶åç§»é™¤
        document.body.appendChild(a);
        a.click();
        
        // å»¶è¿Ÿæ¸…ç†
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(blobUrl);
        }, 100);
        
        photoPreviewMode.classList.remove('active');
        stopCamera();
        
        // é‡ç½®æç¤ºåŠ¨ç”»
        longPressTip.style.animation = 'none';
        
        // ç»™ç”¨æˆ·æç¤º
        setTimeout(() => {
          alert('ç…§ç‰‡å·²ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹ï¼\n\nå¦‚æœæ²¡æœ‰è‡ªåŠ¨ä¸‹è½½ï¼Œè¯·é•¿æŒ‰ç…§ç‰‡é€‰æ‹©"ä¿å­˜å›¾ç‰‡"ã€‚');
        }, 200);
        
      } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        // å¦‚æœè‡ªåŠ¨ä¸‹è½½å¤±è´¥ï¼Œæä¾›å¤‡ç”¨æ–¹æ¡ˆï¼Œä½†ä¸å…³é—­é¢„è§ˆ
        alert('è‡ªåŠ¨ä¸‹è½½å¤±è´¥\n\nè¯·é•¿æŒ‰ç…§ç‰‡ï¼Œåœ¨å¼¹å‡ºèœå•ä¸­é€‰æ‹©"ä¿å­˜å›¾ç‰‡"æˆ–"ä¸‹è½½å›¾ç‰‡"');
        // ä¸å…³é—­é¢„è§ˆç•Œé¢ï¼Œè®©ç”¨æˆ·å¯ä»¥é•¿æŒ‰ä¿å­˜
      }
    };

    // ============== å“åº”å¼å¤„ç† ==============
    window.addEventListener('resize', () => {
      isMobile = window.innerWidth <= 768;
    });

    // é¡µé¢å¸è½½æ—¶å…³é—­æ‘„åƒå¤´
    window.addEventListener('beforeunload', () => {
      stopCamera();
    });
  </script>
</body>
</html>
